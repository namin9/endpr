# WP-API-01: Slug Policy Alignment Proposal

## 1) 배경 / 문제정의
현재 API(Worker)에서 슬러그 생성/검증 정책이 계약면과 불일치할 가능성이 있다. 특히 한글 슬러그 허용, 예약어 차단, 중복 suffix, 발행 후 변경 금지 등이 계약면에서 명시되었으나, 코드상 강제 여부가 불분명하거나 미구현으로 보인다. 본 문서는 **동작 변경 없이** 현 상태를 분석하고, 계약면과의 정합성을 맞추기 위한 구현 옵션과 향후 작업 범위를 정의한다.

## 2) 계약면 발췌 요약
**슬러그 정책/예약어 (read.md)**
- 한글 허용
- 공백 → 하이픈, 특수문자 제거
- 중복 시 -2, -3 자동 suffix
- v1 정책: 발행 후 slug 변경 금지
- 예약어 목록: `posts`, `category`, `tag`, `search`, `assets`, `api`, `cms`, `sitemap.xml`, `robots.txt`

## 3) 현 구현 분석
**슬러그 생성 함수**
- `apps/api/src/db.ts`의 `generateSlug()`
  - 입력을 소문자화 + NFKD 정규화 후 결합 분해 악센트 제거
  - 정규식 `/[^a-z0-9]+/g` 기반으로 **영문/숫자 이외를 하이픈으로 치환**
  - 결과가 비면 `post-<uuid>`로 대체

**슬러그가 결정되는 시점**
- `POST /cms/posts`: 요청 body의 `slug`가 있으면 `generateSlug(slug)`, 없으면 `generateSlug(title)`로 생성
- `POST /cms/posts/:id/autosave`: 요청 body의 `slug`가 있으면 `generateSlug(slug)`로 재생성 (없으면 기존 slug 유지)
- `POST /cms/posts/:id/publish`: slug 재결정 로직 없음 (현 상태 그대로 publish 처리)

**중복/예약어/발행 후 변경 금지 처리**
- 중복 처리: `generateSlug()` 내부에 suffix 처리 없음. DB에서 중복을 검사하거나 suffix를 추가하는 로직도 현재 확인되지 않음.
- 예약어 처리: 확인된 코드 기준 예약어 차단 로직 없음.
- 발행 후 변경 금지: autosave에서 slug가 들어오면 언제든 재생성하여 업데이트 가능. publish 이후 변경을 차단하는 로직 없음.

## 4) 갭 분석(계약 vs 구현)
| 항목 | 계약(요구) | 현 구현 | 갭 |
|---|---|---|---|
| 한글 허용 | 한글 slug 허용 | 영문/숫자 이외 문자 제거 → 한글 제거 | **불일치** |
| 공백 → 하이픈 | 공백 하이픈 | 공백 포함 모든 비영문/숫자를 하이픈으로 | **일치(일부)** |
| 특수문자 제거 | 특수문자 제거 | 특수문자 포함 모든 비영문/숫자 제거 | **일치(일부)** |
| 중복 suffix | -2, -3 자동 suffix | 미구현 | **불일치** |
| 예약어 차단 | 예약어 사용 금지 | 미구현 | **불일치** |
| 발행 후 변경 금지 | publish 후 변경 불가 | autosave에서 slug 변경 가능 | **불일치** |
| 빈 슬러그 처리 | 정의 없음(암묵적으로 허용) | 비면 `post-<uuid>` 생성 | **추가 동작(계약 미정)** |

## 5) 옵션 제안
### Option A: 계약면 그대로 — Unicode slug 허용
**요지**
- slug 생성/정규화에서 **한글 및 유니코드**를 허용한다.
- 공백 → 하이픈, 특수문자 제거 규칙을 유니코드 친화적으로 재정의.
- URL 퍼센트 인코딩 고려(라우팅/퍼블릭 URL에서 안전하게 사용).

**장점**
- 계약면(한글 허용)과 정합성 확보.
- 사용자 경험 개선(원문 제목 반영).

**단점/리스크**
- 퍼센트 인코딩/디코딩 처리 일관성 필요 (라우팅, 링크, CMS UI 등).
- 일부 외부 시스템(분석/리포트/SEO 도구)에서 유니코드 처리 이슈 가능.

**롤아웃**
- 신규 draft에서만 적용 → publish 시점까지 slug 재검증.
- 기존 published 글은 변경 금지.

### Option B: 사용자 입력 slug 필드 도입(UX) + 자동 생성은 참고값
**요지**
- CMS에서 slug를 명시 입력 가능하게 하고, 자동 생성 값은 초기값으로 제시.
- 계약/DB/엔드포인트 변경 없이 **서버에서 입력된 slug를 그대로 검증/정규화**하는 방식.

**장점**
- 사용자 제어 강화(한글/영문 정책 선택 가능).
- 자동 생성값을 유지하되, 필요 시 수정 가능.

**단점/리스크**
- UI 변경이 필요 (본 WP 범위 밖).
- 서버에서 허용 규칙이 명확히 정의되지 않으면 혼란 지속.

**롤아웃**
- CMS UX 변경은 별도 WP로 분리.
- 서버 검증 로직부터 선행하여 정책 일관성 확보.

## 6) 권장안(선택) + 이유
**권장안: Option A (계약면 그대로 — Unicode slug 허용)**
- 계약면이 이미 “한글 허용”을 명시하고 있으므로, 계약 준수 우선.
- 예약어 차단/중복 suffix/발행 후 변경 금지를 포함한 전체 정책을 서버에서 명확히 강제할 때, 유니코드 허용은 가장 직관적이고 일관된 방향.

## 7) 롤아웃/마이그레이션 전략
- **published 글의 slug 변경 금지(v1)**: 기존 발행 글은 slug 그대로 유지.
- **draft 글에 한해 조정 가능**: draft 상태에서만 slug 재생성/수정 허용.
- **정규화 규칙 변경은 신규 draft부터 적용**: 기존 데이터에 대한 일괄 변경은 금지.
- **예약어/중복 검증은 publish 전 차단**: 사용자에게 명확한 에러 반환.

## 8) 테스트 계획(예시 케이스 포함)
1. **한글 제목**: `안녕하세요 세계` → slug가 한글을 보존하고 공백은 하이픈으로 변환되는지.
2. **공백 포함**: `Hello World` → `hello-world` 생성.
3. **특수문자 제거**: `Hello!! @World` → `hello-world` 생성.
4. **이모지 포함**: `Hello 😄 World` → 이모지 제거, 나머지 정규화.
5. **중복 slug**: 동일 title로 2개 생성 시 `slug`, `slug-2`, `slug-3` 순번 부여.
6. **예약어 차단**: `posts`, `api`, `robots.txt` 등 입력 시 400 오류.
7. **대소문자**: `My-Post`와 `my-post`를 동일 slug로 처리하는지.
8. **빈 slug**: title/slug가 비어 있을 때 에러 처리 또는 fallback 정책 확인.
9. **발행 후 수정 시도**: published 글의 slug 변경 요청 시 400/409 거부.
10. **publish 경로 검증**: `/cms/posts/:id/publish`에서 slug 재검증이 수행되는지.

## 9) 다음 작업(WP 분해)
- **WP-API-02: API 단계 예약어 사전 차단(발행 전)**
  - `generateSlug` 이후 예약어 목록 검사.
  - `/cms/posts`, `/cms/posts/:id/autosave`, `/cms/posts/:id/publish` 모두에서 적용.

- **WP-API-03: slug 중복 suffix 정책 구현/검증**
  - 동일 tenant 내 slug 중복 시 `-2`, `-3` 자동 부여.
  - 신규 생성 및 autosave 모두 적용.

- **WP-API-04: 발행 후 slug 변경 강제 차단(서버)**
  - published 상태에서 slug 변경 요청 시 거부.
  - publish 시점에 최종 slug 고정 및 재검증.

- **(필요 시) CMS slug 편집 UX**
  - 사용자 입력 필드 제공.
  - 자동 생성값과 검증 메시지 표시.
